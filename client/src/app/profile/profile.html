<div class="profile-container">
  <div class="interactive-controls">
    <div class="background-controls">
      <button class="background-icon-button" (click)="toggleBgSelector()">
        <span class="material-icons">image</span>
      </button>

      <div class="background-selector-row" [class.active]="showBgSelector">
        @for (scheme of schemes; track $index) {
          <button class="background-thumb preset" (click)="setScheme($index)">
            @for (color of scheme; track color) {
              <span class="thumb-color" [style.background]="color"></span>
            }
          </button>
        }
        <button class="background-thumb advanced" (click)="toggleAdjuster()">
          <span class="material-icons">tune</span>
        </button>
      </div>
    </div>

    <div class="color-adjuster-panel" [class.active]="showAdjuster"> 
      <div class="color-adjuster-header"> 
        <h3 class="color-adjuster-title">Color Adjuster</h3> 
        <button class="color-adjuster-close" (click)="toggleAdjuster()">√ó</button> 
      </div> 

      @for (color of colors; track $index) {
        <div class="color-picker-group"> 
          <div class="color-picker-label"> 
            <span>Color {{ $index + 1 }}</span> 
          </div> 
          <div class="color-picker-wrapper"> 
            <input type="color" class="color-picker-input" [value]="color" (input)="updateColor($index, $event)"> 
            <input type="text" class="color-value-display" [value]="color" readonly> 
            <button class="copy-btn" (click)="copyToClipboard(color)">Copy</button> 
          </div> 
        </div> 
      }

      <div class="color-adjuster-actions"> 
        <button class="export-btn" (click)="exportColors()">Export All Colors</button> 
      </div> 
    </div>
  </div>

  <div class="profile-header">
    <div class="profile-avatar-container" (click)="isOwnProfile && fileInput.click()">
      <div class="profile-avatar">
        @if (displayProfile?.avatar_url) {
          <img [src]="displayProfile?.avatar_url" alt="Profile Picture">
        } @else {
          <span>üë§</span>
        }
      </div>
      @if (isOwnProfile) {
        <div class="avatar-overlay">
          <span class="material-icons">edit</span>
        </div>
      }
      <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/png, image/jpeg, image/gif" style="display: none">
    </div>
    <div class="profile-info">
      <h1>{{ displayProfile?.display_name }}</h1>
      <div class="profile-badge">
        <span class="profile-status">Active Member</span>
      </div>
    </div>
  </div>

  <div class="profile-content">
    @if (!isFriendsPage) {
      <div class="profile-section">
        <div class="section-header">
          <h2>Account Information</h2>
          @if (isOwnProfile) {
            <div class='wrapper' (click)="toggleEdit()">
              <div role='button' [class]="'retro-btn sm ' + (isEditing ? 'danger' : 'info')">
                <a class='btn'>
                  <span class='btn-inner'>
                    <span class='content-wrapper'>
                      <span class='btn-content'>
                        <span class='btn-content-inner'>{{ isEditing ? 'Cancel' : 'Edit' }}</span>
                      </span>
                    </span>
                  </span>
                </a>
              </div>
            </div>
          }
        </div>

        @if (!isEditing) {
          <div class="info-grid">
            <div class="info-item">
              <label>Name</label>
              <p>{{ displayProfile?.display_name }}</p>
            </div>
            <div class="info-item">
              <label>Member Since</label>
              <p>February 2026</p>
            </div>
            <div class="info-item">
              <label>Status</label>
              <p>Active</p>
            </div>
          </div>
        } @else {
          <div class="edit-form-container">
            <div class="form-grid">
              <div class="form-group">
                <label>Display Name</label>
                <input type="text" [(ngModel)]="editForm.display_name" placeholder="Enter your name">
              </div>
            </div>
            <div class="form-actions">
              <div class='wrapper' (click)="saveProfile()">
                <div role='button' class='retro-btn primary'>
                  <a class='btn'>
                    <span class='btn-inner'>
                      <span class='content-wrapper'>
                        <span class='btn-content'>
                          <span class='btn-content-inner'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        </span>
                      </span>
                    </span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      @if (isOwnProfile) {
        <div class="profile-section kyosor-section">
          <div class="section-header">
            <h2>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
            <div class="section-actions">
              <div class='wrapper' (click)="showCalendar = !showCalendar">
                <div role='button' class='retro-btn sm info'>
                  <a class='btn'>
                    <span class='btn-inner'>
                      <span class='content-wrapper'>
                        <span class='btn-content'>
                          <span class='btn-content-inner'>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
                        </span>
                      </span>
                    </span>
                  </a>
                </div>
              </div>
            </div>
          </div>

          @if (showCalendar) {
            <div class="calendar-container">
              <div class="calendar-header">
                <button class="month-btn" (click)="prevMonth()">
                  <span class="material-icons">chevron_left</span>
                </button>
                <h3>{{ currentMonthLabel }}</h3>
                <button class="month-btn" (click)="nextMonth()">
                  <span class="material-icons">chevron_right</span>
                </button>
              </div>

              <div class="calendar-grid">
                <div class="weekday">‡∏≠‡∏≤</div>
                <div class="weekday">‡∏à</div>
                <div class="weekday">‡∏≠</div>
                <div class="weekday">‡∏û</div>
                <div class="weekday">‡∏û‡∏§</div>
                <div class="weekday">‡∏®</div>
                <div class="weekday">‡∏™</div>

                @for (day of calendarDays; track $index) {
                  <div class="calendar-day" [class.empty]="!day.day">
                    @if (day.day) {
                      <span class="day-number">{{ day.day }}</span>
                      <div class="mission-names">
                        @for (m of day.missions; track m.id) {
                          <div class="mission-name-tag" [class.completed]="m.status === 'Completed'" [title]="m.name">
                            {{ m.name }}
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      @if (!isChangingPassword) {
        <div class="profile-section">
          <h2>Activity</h2>
          <div class="activity-list">
            <div class="activity-item">
              <span class="activity-date">Today</span>
              <p>You logged in to your account</p>
            </div>
            <div class="activity-item">
              <span class="activity-date">Yesterday</span>
              <p>You updated your profile</p>
            </div>
          </div>
        </div>

        <div class="profile-actions">
          <button class="btn btn-secondary" (click)="startChangePassword()">Change Password</button>
        </div>
      } @else {
        <div class="profile-section change-password-section">
          <div class="section-header">
            <h2>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
          </div>
          <form [formGroup]="changePasswordForm" (ngSubmit)="submitChangePassword()" class="change-password-form">
            <div class="form-grid">
              <div class="form-group">
                <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                <input type="text" formControlName="email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ">
              </div>
              <div class="form-group">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                <input type="password" formControlName="newPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
              </div>
              <div class="form-group">
                <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                <input type="password" formControlName="cf_password" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
              </div>
            </div>
            @if (serverError) {
              <div class="change-password-error">
                {{ serverError }}
              </div>
            }
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancelChangePassword()">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            </div>
          </form>
        </div>
      }
    }

    @if (isFriendsPage) {
      <div class="profile-section friends-section">
        <div class="section-header">
          <h2>Friends</h2>
        </div>

        <div class="friends-content">
          <div class="friend-search">
            <input
              type="text"
              [(ngModel)]="friendSearchTerm"
              placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ..."
            >
          </div>

          <div class="friends-list">
            @if (filteredFriends.length > 0) {
              @for (friend of filteredFriends; track friend.display_name) {
                <div class="friend-card">
                  <div class="friend-avatar">
                    @if (friend.avatar_url) {
                      <img [src]="friend.avatar_url" alt="{{ friend.display_name }}">
                    } @else {
                      <span>{{ friend.display_name.charAt(0) }}</span>
                    }
                  </div>
                  <div class="friend-info">
                    <div class="friend-name">{{ friend.display_name }}</div>
                    <button class="friend-remove" (click)="removeFriend(friend.display_name)">
                      ‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                    </button>
                    <div class="friend-missions">
                      <div class="friend-missions-title">Mission ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥</div>
                      @if (getFriendMissions(friend).length > 0) {
                        <div class="friend-mission-list">
                          @for (mission of getFriendMissions(friend); track mission.id) {
                            <div class="friend-mission-item">
                              <div class="mission-main">
                                <span class="mission-name">{{ mission.name }}</span>
                                <span class="mission-status" [ngClass]="'status-' + mission.status">
                                  {{ mission.status === 'Completed' ? '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : (mission.status === 'InProgress' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' : '‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà') }}
                                </span>
                              </div>
                              <div class="mission-actions">
                                @if (canJoinFriendMission(mission)) {
                                  <button class="friend-join-btn" (click)="joinFriendMission(mission)">
                                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ
                                  </button>
                                } @else if (mission.status === 'Completed') {
                                  <span class="mission-disabled-label">
                                    ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                                  </span>
                                }
                              </div>
                            </div>
                          }
                        </div>
                      } @else {
                        <div class="friends-empty-muted">
                          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            } @else if (friendSearchTerm.trim().length === 0 && friends.length === 0) {
              <div class="friends-empty">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
              </div>
            }
          </div>

          @if (isOwnProfile && filteredAvailableFriends.length > 0 && friendSearchTerm.trim().length > 0) {
            <div class="friend-search-results">
              <h3 class="friends-subtitle">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
              <div class="friends-list">
                @for (user of filteredAvailableFriends; track user.display_name) {
                  <div class="friend-card">
                    <div class="friend-avatar">
                      @if (user.avatar_url) {
                        <img [src]="user.avatar_url" alt="{{ user.display_name }}">
                      } @else {
                        <span>{{ user.display_name.charAt(0) }}</span>
                      }
                    </div>
                    <div class="friend-info">
                      <div class="friend-name">{{ user.display_name }}</div>
                      <div class="friend-meta">
                        {{ user.institution || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô' }}
                      </div>
                      <button class="friend-add" (click)="sendFriendRequestTo(user.display_name)">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          } @else if (isOwnProfile && friendSearchTerm.trim().length > 0 && filteredAvailableFriends.length === 0 && filteredFriends.length === 0) {
            <div class="friends-empty">
              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô
            </div>
          }

          @if (isOwnProfile && incomingRequests.length > 0) {
            <div class="friend-requests incoming">
              <h3 class="friends-subtitle">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</h3>
              <div class="friends-list">
                @for (req of incomingRequests; track req.display_name) {
                  <div class="friend-card">
                    <div class="friend-avatar">
                      @if (req.avatar_url) {
                        <img [src]="req.avatar_url" alt="{{ req.display_name }}">
                      } @else {
                        <span>{{ req.display_name.charAt(0) }}</span>
                      }
                    </div>
                    <div class="friend-info">
                      <div class="friend-name">{{ req.display_name }}</div>
                      <div class="friend-meta">
                        {{ req.institution || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô' }}
                      </div>
                      <button class="friend-accept" (click)="acceptFriendRequest(req.display_name)">
                        ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          @if (isOwnProfile && outgoingRequests.length > 0) {
            <div class="friend-requests outgoing">
              <h3 class="friends-subtitle">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h3>
              <div class="friends-list">
                @for (req of outgoingRequests; track req.display_name) {
                  <div class="friend-card">
                    <div class="friend-avatar">
                      @if (req.avatar_url) {
                        <img [src]="req.avatar_url" alt="{{ req.display_name }}">
                      } @else {
                        <span>{{ req.display_name.charAt(0) }}</span>
                      }
                    </div>
                    <div class="friend-info">
                      <div class="friend-name">{{ req.display_name }}</div>
                      <div class="friend-meta">
                        {{ req.institution || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô' }}
                      </div>
                      <span class="friend-status-pending">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }

    <div class="back-nav-bottom">
      <div class='wrapper' routerLink="/">
        <div role='button' class='retro-btn info'>
          <a class='btn'>
            <span class='btn-inner'>
              <span class='content-wrapper'>
                <span class='btn-content'>
                  <span class='btn-content-inner'>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
                </span>
              </span>
            </span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
